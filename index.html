<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>李浩瑾好帅</title>
  
  <!-- 预连接到关键域名，减少DNS查询和连接建立时间 -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com">
  
  <!-- 关键CSS优先加载 -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 非关键资源延迟加载 -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"></noscript>
  
  <!-- Firebase核心库优先加载，功能库按需加载 -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js"></script>
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36BFFA',
            dark: '#1E293B',
            light: '#F8FAFC',
            accent: '#7C3AED',
            highlight: '#FFF9C4', // 搜索高亮颜色
            warning: '#F59E0B'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .message-appear {
        animation: fadeIn 0.3s ease forwards;
      }
      .pulse-animation {
        animation: pulse 2s infinite;
      }
      .shake {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      }
      .search-highlight {
        background-color: theme('colors.highlight');
        padding: 0 2px;
        border-radius: 2px;
      }
      .user-muted {
        opacity: 0.6;
      }
      .blurred {
        filter: blur(4px);
      }
      .badge-warning {
        @apply bg-warning/10 text-warning text-xs px-2 py-0.5 rounded-full;
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes shake {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-3px); }
      40%, 60% { transform: translateX(3px); }
    }
  </style>
</head>

<body class="font-inter bg-gray-100 text-dark h-screen flex flex-col overflow-hidden">
  <!-- 加载提示 -->
  <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
    <div class="text-center">
      <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-600">连接到服务器...</p>
    </div>
  </div>

  <!-- 密码验证页面 -->
  <div id="password-screen" class="flex-1 flex flex-col items-center justify-center p-4 bg-gradient-to-br from-primary to-secondary hidden">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 transform transition-all duration-500 hover:shadow-primary/20">
      <div class="text-center mb-8">
        <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-primary mb-2">聊天室</h1>
        <p class="text-gray-500">请输入访问密码</p>
      </div>
      
      <form id="password-form" class="space-y-6">
        <div>
          <label for="access-password" class="block text-sm font-medium text-gray-700 mb-1">访问密码</label>
          <div class="relative">
            <input type="password" id="access-password" 
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none"
                  placeholder="请输入访问密码" required>
            <button type="button" id="toggle-access-password" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-primary">
              <i class="fa fa-eye-slash"></i>
            </button>
          </div>
        </div>
        
        <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-primary/30">
          进入聊天室
        </button>
      </form>
      
      <!-- 浏览模式按钮 -->
      <button id="browse-mode-btn" class="w-full mt-4 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all">
        <i class="fa fa-eye mr-2"></i>以游客身份浏览
      </button>
      
      <div id="password-error" class="mt-4 text-center text-red-500 hidden">
        <i class="fa fa-exclamation-circle mr-1"></i> 密码错误，请重试
      </div>
    </div>
  </div>

  <!-- 用户认证页面 (登录/注册) -->
  <div id="auth-screen" class="flex-1 flex flex-col items-center justify-center p-4 bg-gradient-to-br from-primary to-secondary hidden">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 transform transition-all duration-500 hover:shadow-primary/20">
      <div class="text-center mb-8">
        <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-primary mb-2">用户认证</h1>
        <div class="flex justify-center items-center space-x-2 mt-2">
          <button id="login-tab" class="px-4 py-1 text-primary font-medium border-b-2 border-primary">登录</button>
          <button id="register-tab" class="px-4 py-1 text-gray-500 font-medium border-b-2 border-transparent hover:text-primary transition-colors">注册</button>
        </div>
      </div>
      
      <!-- 登录表单 -->
      <form id="login-form" class="space-y-6">
        <div>
          <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
          <input type="text" id="login-username" 
                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none"
                placeholder="请输入用户名" required>
        </div>
        
        <div>
          <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
          <div class="relative">
            <input type="password" id="login-password" 
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none"
                  placeholder="请输入密码" required>
            <button type="button" id="toggle-login-password" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-primary">
              <i class="fa fa-eye-slash"></i>
            </button>
          </div>
        </div>
        
        <!-- 记住我选项 -->
        <div class="flex items-center">
          <input type="checkbox" id="remember-me" class="w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
          <label for="remember-me" class="ml-2 block text-sm text-gray-700">
            记住我
          </label>
        </div>
        
        <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-primary/30">
          登录
        </button>
      </form>
      
      <!-- 注册表单 (默认隐藏) -->
      <form id="register-form" class="space-y-6 hidden">
        <div>
          <label for="register-username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
          <input type="text" id="register-username" 
                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none"
                placeholder="请设置用户名" required>
        </div>
        
        <div>
          <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
          <div class="relative">
            <input type="password" id="register-password" 
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none"
                  placeholder="请设置密码" required>
            <button type="button" id="toggle-register-password" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-primary">
              <i class="fa fa-eye-slash"></i>
            </button>
          </div>
        </div>
        
        <div>
          <label for="register-confirm" class="block text-sm font-medium text-gray-700 mb-1">确认密码</label>
          <div class="relative">
            <input type="password" id="register-confirm" 
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none"
                  placeholder="请再次输入密码" required>
            <button type="button" id="toggle-confirm-password" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-primary">
              <i class="fa fa-eye-slash"></i>
            </button>
          </div>
        </div>
        
        <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] shadow-lg hover:shadow-primary/30">
          注册
        </button>
      </form>
      
      <div id="auth-message" class="mt-4 text-center hidden"></div>
    </div>
  </div>

  <!-- 聊天室主界面 -->
  <div id="chat-screen" class="flex flex-col h-screen hidden">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md py-3 px-4 md:px-6 flex items-center justify-between z-10">
      <div class="flex items-center">
        <h1 class="text-xl font-bold text-primary flex items-center">
          <i class="fa fa-comments-o mr-2"></i> 跨设备公共聊天室
        </h1>
        <span id="online-indicator" class="ml-3 text-sm px-2 py-1 bg-green-100 text-green-800 rounded-full flex items-center">
          <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
          <span id="online-count">0</span> 人在线
        </span>
        <span id="connection-status" class="ml-3 text-sm px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full flex items-center hidden">
          <span class="w-2 h-2 bg-yellow-500 rounded-full mr-1"></span>
          连接中...
        </span>
        
        <!-- 游客模式提示 -->
        <span id="guest-mode-indicator" class="ml-3 text-sm px-2 py-1 bg-orange-100 text-orange-800 rounded-full flex items-center hidden">
          <i class="fa fa-info-circle mr-1"></i> 游客模式，无法发送消息
        </span>
        
        <!-- 禁言提示 -->
        <span id="muted-indicator" class="ml-3 text-sm px-2 py-1 bg-warning/10 text-warning rounded-full flex items-center hidden">
          <i class="fa fa-lock mr-1"></i> 已被禁言
        </span>
      </div>
      
      <div class="flex items-center space-x-4">
        <button id="clear-chat-btn" class="text-gray-600 hover:text-primary transition-colors text-sm">
          <i class="fa fa-trash-o mr-1"></i>
          <span class="hidden md:inline">清空记录</span>
        </button>
        
        <!-- 举报管理按钮 (仅李浩瑾可见) -->
        <button id="reports-btn" class="text-gray-600 hover:text-primary transition-colors text-sm hidden">
          <i class="fa fa-flag mr-1"></i>
          <span class="hidden md:inline">举报管理</span>
          <span id="reports-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center hidden">0</span>
        </button>
        
        <span id="current-user" class="hidden md:inline-block text-sm font-medium"></span>
        <button id="logout-btn" class="text-gray-600 hover:text-primary transition-colors">
          <i class="fa fa-sign-out mr-1"></i>
          <span class="hidden md:inline">退出</span>
        </button>
        
        <!-- 游客登录按钮 -->
        <button id="guest-login-btn" class="bg-primary hover:bg-primary/90 text-white px-3 py-1.5 rounded-lg text-sm hidden">
          <i class="fa fa-user mr-1"></i>登录
        </button>
      </div>
    </header>
    
    <!-- 主要内容区 -->
    <main class="flex-1 flex overflow-hidden">
      <!-- 左侧用户列表 -->
      <aside class="w-full md:w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col">
        <div class="p-3 border-b border-gray-200">
          <div class="relative">
            <input type="text" id="user-search" placeholder="搜索用户..." 
                  class="w-full px-3 py-2 text-sm bg-gray-100 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
            <i class="fa fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <span id="user-search-results" class="absolute left-3 top-full mt-1 text-xs text-gray-500 hidden"></span>
          </div>
        </div>
        
        <div class="overflow-y-auto flex-1 scrollbar-hide">
          <div class="p-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">在线用户</div>
          <div id="online-user-list" class="divide-y divide-gray-100">
            <!-- 在线用户列表将通过JS动态生成 -->
          </div>
          
          <div class="p-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-4">离线用户</div>
          <div id="offline-user-list" class="divide-y divide-gray-100">
            <!-- 离线用户列表将通过JS动态生成 -->
          </div>
          
          <div class="p-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-4">已屏蔽用户</div>
          <div id="blocked-user-list" class="divide-y divide-gray-100">
            <!-- 已屏蔽用户列表将通过JS动态生成 -->
          </div>
        </div>
      </aside>
      
      <!-- 中间聊天区域 -->
      <div class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
        <!-- 聊天标题栏 -->
        <div id="chat-header" class="bg-white border-b border-gray-200 p-3 flex items-center">
          <i class="fa fa-users text-primary mr-2"></i>
          <h2 id="chat-title" class="font-medium">公共聊天</h2>
          <span id="private-indicator" class="ml-2 text-xs px-2 py-0.5 bg-accent/10 text-accent rounded-full hidden">私聊</span>
          
          <!-- 消息搜索框 -->
          <div class="relative ml-auto max-w-xs w-full md:max-w-sm">
            <input type="text" id="message-search" placeholder="搜索消息..." 
                  class="w-full px-3 py-1.5 text-sm bg-gray-100 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
            <i class="fa fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <button id="clear-message-search" class="absolute right-8 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
              <i class="fa fa-times-circle"></i>
            </button>
            <span id="message-search-results" class="absolute left-3 top-full mt-1 text-xs text-gray-500 hidden"></span>
          </div>
          
          <button id="back-to-public" class="ml-2 text-gray-500 hover:text-primary transition-colors hidden">
            <i class="fa fa-arrow-left"></i>
          </button>
        </div>
        
        <!-- 聊天消息区域 -->
        <div id="messages-container" class="flex-1 p-4 overflow-y-auto scrollbar-hide space-y-4">
          <!-- 消息将通过JS动态生成 -->
          <div class="text-center text-gray-500 text-sm">
            今天是 <span id="current-date"></span>
          </div>
        </div>
        
        <!-- 输入区域 -->
        <div class="bg-white border-t border-gray-200 p-3">
          <!-- 禁言提示 -->
          <div id="mute-hint" class="mb-3 text-center text-sm text-warning hidden">
            <i class="fa fa-exclamation-triangle mr-1"></i> 您已被禁言，<span id="mute-end-time"></span> 后可发言
          </div>
          
          <!-- 游客提示 -->
          <div id="guest-input-hint" class="mb-3 text-center text-sm text-orange-500 hidden">
            <i class="fa fa-info-circle mr-1"></i> 请登录后发送消息
          </div>
          
          <form id="message-form" class="flex space-x-2">
            <textarea id="message-input" rows="1" placeholder="输入消息..." 
                    class="flex-1 px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none resize-none"></textarea>
            <button type="submit" class="bg-primary hover:bg-primary/90 text-white p-2 rounded-lg transition-all transform hover:scale-105 active:scale-95">
              <i class="fa fa-paper-plane"></i>
            </button>
          </form>
          
          <!-- 敏感词提示 -->
          <div id="sensitive-word-hint" class="mt-2 text-xs text-red-500 hidden">
            <i class="fa fa-info-circle mr-1"></i> 消息中包含敏感词汇，已自动过滤
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 举报管理面板 (仅李浩瑾可见) -->
  <div id="reports-panel" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-all">
      <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900">举报管理</h3>
        <button id="close-reports-panel" class="text-gray-500 hover:text-gray-700">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="overflow-y-auto flex-1 p-4">
        <div id="no-reports" class="text-center py-8 text-gray-500 hidden">
          <i class="fa fa-flag-o text-4xl mb-2 opacity-30"></i>
          <p>暂无待处理的举报</p>
        </div>
        
        <div id="reports-list" class="space-y-4">
          <!-- 举报列表将通过JS动态生成 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 踢人确认对话框 -->
  <div id="kick-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">确认踢人</h3>
      <p class="text-gray-600 mb-4">您确定要将 <span id="kick-username" class="font-medium"></span> 踢出聊天室吗？</p>
      <div class="flex justify-end space-x-3">
        <button id="cancel-kick" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
          取消
        </button>
        <button id="confirm-kick" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
          确认踢出
        </button>
      </div>
    </div>
  </div>

  <!-- 删除消息确认对话框 -->
  <div id="delete-message-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">确认删除消息</h3>
      <p class="text-gray-600 mb-4">您确定要删除这条消息吗？此操作将对所有用户生效。</p>
      <div class="flex justify-end space-x-3">
        <button id="cancel-delete-message" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
          取消
        </button>
        <button id="confirm-delete-message" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
          确认删除
        </button>
      </div>
    </div>
  </div>

  <!-- 举报确认对话框 -->
  <div id="report-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">举报消息</h3>
      <p class="text-gray-600 mb-4">您确定要举报 <span id="report-sender" class="font-medium"></span> 发送的这条消息吗？</p>
      <div class="mb-4">
        <label for="report-reason" class="block text-sm font-medium text-gray-700 mb-1">举报原因</label>
        <select id="report-reason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
          <option value="spam">垃圾信息</option>
          <option value="abuse">辱骂攻击</option>
          <option value="sensitive">敏感内容</option>
          <option value="other">其他原因</option>
        </select>
      </div>
      <div class="flex justify-end space-x-3">
        <button id="cancel-report" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
          取消
        </button>
        <button id="confirm-report" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
          确认举报
        </button>
      </div>
    </div>
  </div>

  <!-- 屏蔽用户确认对话框 -->
  <div id="block-user-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">确认屏蔽用户</h3>
      <p class="text-gray-600 mb-4">您确定要屏蔽 <span id="block-username" class="font-medium"></span> 吗？您将不再看到他们发送的消息。</p>
      <div class="flex justify-end space-x-3">
        <button id="cancel-block" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
          取消
        </button>
        <button id="confirm-block" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
          确认屏蔽
        </button>
      </div>
    </div>
  </div>

  <!-- 取消屏蔽用户确认对话框 -->
  <div id="unblock-user-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">确认取消屏蔽</h3>
      <p class="text-gray-600 mb-4">您确定要取消屏蔽 <span id="unblock-username" class="font-medium"></span> 吗？您将重新看到他们发送的消息。</p>
      <div class="flex justify-end space-x-3">
        <button id="cancel-unblock" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
          取消
        </button>
        <button id="confirm-unblock" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
          确认取消屏蔽
        </button>
      </div>
    </div>
  </div>

  <!-- 清空聊天记录确认对话框 -->
  <div id="clear-chat-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">确认清空聊天记录</h3>
      <p class="text-gray-600 mb-4">您确定要删除所有聊天记录吗？此操作仅会影响您自己看到的记录，且无法恢复。</p>
      <div class="flex justify-end space-x-3">
        <button id="cancel-clear-chat" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
          取消
        </button>
        <button id="confirm-clear-chat" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
          确认清空
        </button>
      </div>
    </div>
  </div>

  <!-- 管理员权限确认对话框 -->
  <div id="admin-permission-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all">
      <h3 class="text-lg font-semibold text-gray-900 mb-2" id="admin-modal-title">授予管理员权限</h3>
      <p class="text-gray-600 mb-4" id="admin-modal-message">您确定要授予 <span id="admin-username" class="font-medium"></span> 管理员权限吗？</p>
      <div class="flex justify-end space-x-3">
        <button id="cancel-admin-action" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
          取消
        </button>
        <button id="confirm-admin-action" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
          确认
        </button>
      </div>
    </div>
  </div>

  <!-- 搜索结果导航 -->
  <div id="search-navigation" class="fixed bottom-20 right-4 bg-white shadow-lg rounded-lg p-2 flex items-center space-x-2 z-40 hidden">
    <button id="search-prev" class="p-2 text-gray-600 hover:text-primary hover:bg-gray-100 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
      <i class="fa fa-chevron-up"></i>
    </button>
    <div class="text-sm text-gray-600">
      <span id="search-current">0</span>/<span id="search-total">0</span>
    </div>
    <button id="search-next" class="p-2 text-gray-600 hover:text-primary hover:bg-gray-100 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
      <i class="fa fa-chevron-down"></i>
    </button>
  </div>

  <!-- 通知提示 -->
  <div id="notification" class="fixed bottom-4 right-4 bg-dark text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50 max-w-xs">
    <i id="notification-icon" class="fa mr-2"></i>
    <span id="notification-text"></span>
  </div>

  <script>
    // 优化点1: 提前初始化Firebase配置但延迟连接
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // 全局状态管理 - 增加连接超时设置
    const state = {
      currentUser: null,
      isGuest: false,
      rememberMe: false,
      users: [],
      messages: [],
      deletedMessages: [],
      blockedUsers: [],
      currentChat: {
        type: 'public',
        target: null
      },
      accessPassword: 'lihaojinshuai',
      kickedUser: null,
      blockedUser: null,
      messageToDelete: null,
      adminActionUser: null,
      adminActionType: null,
      isConnected: false,
      connectionTimeout: null, // 连接超时计时器
      search: {
        userQuery: '',
        messageQuery: '',
        messageResults: [],
        currentResultIndex: -1
      },
      // 新增：敏感词和举报相关状态
      sensitiveWords: [
        '敏感词1', '敏感词2', '敏感词3', '暴力', '色情', '赌博', 
        '毒品', '反动', '侮辱', '诽谤', '攻击', '歧视', '垃圾信息'
      ],
      reports: [], // 存储举报信息
      mutedUsers: {}, // 存储被禁言用户及其禁言结束时间
      reportCounts: {}, // 存储用户被举报成功的次数
      reportedMessage: null // 当前正在举报的消息
    };

    // DOM元素
    const elements = {
      // 加载屏幕
      loadingScreen: document.getElementById('loading-screen'),
      
      // 屏幕元素
      passwordScreen: document.getElementById('password-screen'),
      authScreen: document.getElementById('auth-screen'),
      chatScreen: document.getElementById('chat-screen'),
      
      // 浏览模式按钮
      browseModeBtn: document.getElementById('browse-mode-btn'),
      guestModeIndicator: document.getElementById('guest-mode-indicator'),
      guestInputHint: document.getElementById('guest-input-hint'),
      guestLoginBtn: document.getElementById('guest-login-btn'),
      
      // 密码表单
      passwordForm: document.getElementById('password-form'),
      accessPassword: document.getElementById('access-password'),
      toggleAccessPassword: document.getElementById('toggle-access-password'),
      passwordError: document.getElementById('password-error'),
      
      // 认证表单
      loginTab: document.getElementById('login-tab'),
      registerTab: document.getElementById('register-tab'),
      loginForm: document.getElementById('login-form'),
      registerForm: document.getElementById('register-form'),
      authMessage: document.getElementById('auth-message'),
      
      // 记住我选项
      rememberMe: document.getElementById('remember-me'),
      
      // 登录表单字段
      loginUsername: document.getElementById('login-username'),
      loginPassword: document.getElementById('login-password'),
      toggleLoginPassword: document.getElementById('toggle-login-password'),
      
      // 注册表单字段
      registerUsername: document.getElementById('register-username'),
      registerPassword: document.getElementById('register-password'),
      registerConfirm: document.getElementById('register-confirm'),
      toggleRegisterPassword: document.getElementById('toggle-register-password'),
      toggleConfirmPassword: document.getElementById('toggle-confirm-password'),
      
      // 聊天界面元素
      currentUser: document.getElementById('current-user'),
      logoutBtn: document.getElementById('logout-btn'),
      onlineUserList: document.getElementById('online-user-list'),
      offlineUserList: document.getElementById('offline-user-list'),
      blockedUserList: document.getElementById('blocked-user-list'),
      userSearch: document.getElementById('user-search'),
      userSearchResults: document.getElementById('user-search-results'),
      messagesContainer: document.getElementById('messages-container'),
      messageForm: document.getElementById('message-form'),
      messageInput: document.getElementById('message-input'),
      chatTitle: document.getElementById('chat-title'),
      privateIndicator: document.getElementById('private-indicator'),
      onlineCount: document.getElementById('online-count'),
      currentDate: document.getElementById('current-date'),
      backToPublic: document.getElementById('back-to-public'),
      connectionStatus: document.getElementById('connection-status'),
      clearChatBtn: document.getElementById('clear-chat-btn'),
      
      // 消息搜索元素
      messageSearch: document.getElementById('message-search'),
      clearMessageSearch: document.getElementById('clear-message-search'),
      messageSearchResults: document.getElementById('message-search-results'),
      searchNavigation: document.getElementById('search-navigation'),
      searchPrev: document.getElementById('search-prev'),
      searchNext: document.getElementById('search-next'),
      searchCurrent: document.getElementById('search-current'),
      searchTotal: document.getElementById('search-total'),
      
      // 踢人功能元素
      kickModal: document.getElementById('kick-modal'),
      kickUsername: document.getElementById('kick-username'),
      cancelKick: document.getElementById('cancel-kick'),
      confirmKick: document.getElementById('confirm-kick'),
      
      // 删除消息功能元素
      deleteMessageModal: document.getElementById('delete-message-modal'),
      cancelDeleteMessage: document.getElementById('cancel-delete-message'),
      confirmDeleteMessage: document.getElementById('confirm-delete-message'),
      
      // 举报功能元素
      reportModal: document.getElementById('report-modal'),
      reportSender: document.getElementById('report-sender'),
      reportReason: document.getElementById('report-reason'),
      cancelReport: document.getElementById('cancel-report'),
      confirmReport: document.getElementById('confirm-report'),
      reportsBtn: document.getElementById('reports-btn'),
      reportsCount: document.getElementById('reports-count'),
      reportsPanel: document.getElementById('reports-panel'),
      closeReportsPanel: document.getElementById('close-reports-panel'),
      noReports: document.getElementById('no-reports'),
      reportsList: document.getElementById('reports-list'),
      
      // 屏蔽用户功能元素
      blockUserModal: document.getElementById('block-user-modal'),
      blockUsername: document.getElementById('block-username'),
      cancelBlock: document.getElementById('cancel-block'),
      confirmBlock: document.getElementById('confirm-block'),
      
      // 取消屏蔽用户功能元素
      unblockUserModal: document.getElementById('unblock-user-modal'),
      unblockUsername: document.getElementById('unblock-username'),
      cancelUnblock: document.getElementById('cancel-unblock'),
      confirmUnblock: document.getElementById('confirm-unblock'),
      
      // 清空聊天记录元素
      clearChatModal: document.getElementById('clear-chat-modal'),
      cancelClearChat: document.getElementById('cancel-clear-chat'),
      confirmClearChat: document.getElementById('confirm-clear-chat'),
      
      // 管理员权限元素
      adminPermissionModal: document.getElementById('admin-permission-modal'),
      adminModalTitle: document.getElementById('admin-modal-title'),
      adminModalMessage: document.getElementById('admin-modal-message'),
      adminUsername: document.getElementById('admin-username'),
      cancelAdminAction: document.getElementById('cancel-admin-action'),
      confirmAdminAction: document.getElementById('confirm-admin-action'),
      
      // 禁言相关元素
      mutedIndicator: document.getElementById('muted-indicator'),
      muteHint: document.getElementById('mute-hint'),
      muteEndTime: document.getElementById('mute-end-time'),
      
      // 敏感词提示
      sensitiveWordHint: document.getElementById('sensitive-word-hint'),
      
      // 通知元素
      notification: document.getElementById('notification'),
      notificationIcon: document.getElementById('notification-icon'),
      notificationText: document.getElementById('notification-text')
    };

    // 初始化 - 优化连接流程
    function init() {
      // 从本地存储加载已删除的消息和已屏蔽的用户（提前加载本地数据）
      loadDeletedMessages();
      loadBlockedUsers();
      
      // 设置当前日期
      const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
      elements.currentDate.textContent = new Date().toLocaleDateString('zh-CN', dateOptions);
      
      // 绑定事件处理程序
      bindEvents();
      
      // 优化点2: 延迟初始化Firebase，先完成DOM和本地数据加载
      setTimeout(() => {
        initializeFirebase();
      }, 100);
      
      // 优化点3: 设置连接超时处理
      state.connectionTimeout = setTimeout(() => {
        if (!state.isConnected) {
          showNotification('连接服务器超时，正在重试...', 'error');
          // 尝试重新初始化连接
          initializeFirebase();
        }
      }, 8000); // 8秒超时
      
      // 检查本地存储中是否有已登录用户（自动登录）
      const savedLogin = localStorage.getItem('savedChatLogin');
      if (savedLogin) {
        try {
          const { username, password } = JSON.parse(savedLogin);
          // 自动填充登录表单
          elements.loginUsername.value = username;
          elements.loginPassword.value = password;
          elements.rememberMe.checked = true;
        } catch (e) {
          console.error('Failed to load saved login:', e);
        }
      }
      
      // 设置自动删除过期消息的定时任务（延迟执行，不阻塞初始连接）
      setTimeout(setupOldMessageCleanup, 5000);
      
      // 启动禁言检查定时器
      setInterval(checkMuteStatus, 1000);
    }

    // 优化点4: 分离Firebase初始化函数，便于重试
    function initializeFirebase() {
      try {
        // 初始化Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 数据库引用
        const usersRef = database.ref('users');
        const messagesRef = database.ref('messages');
        const presenceRef = database.ref('.info/connected');
        const userStatusRef = database.ref('userStatus');
        // 新增：举报和禁言相关引用
        const reportsRef = database.ref('reports');
        const mutedUsersRef = database.ref('mutedUsers');
        const reportCountsRef = database.ref('reportCounts');
        
        // 保存全局引用
        window.usersRef = usersRef;
        window.messagesRef = messagesRef;
        window.userStatusRef = userStatusRef;
        window.reportsRef = reportsRef;
        window.mutedUsersRef = mutedUsersRef;
        window.reportCountsRef = reportCountsRef;
        
        // 设置Firebase监听器
        setupFirebaseListeners(usersRef, messagesRef, presenceRef, userStatusRef, reportsRef, mutedUsersRef, reportCountsRef);
        
      } catch (error) {
        console.error('Firebase initialization error:', error);
        showNotification('连接服务器失败，正在重试...', 'error');
        // 重试连接
        setTimeout(initializeFirebase, 3000);
      }
    }

    // 设置自动删除过期消息的定时任务
    function setupOldMessageCleanup() {
      // 立即执行一次检查
      deleteOldMessages();
      
      // 每天检查一次过期消息
      setInterval(deleteOldMessages, 24 * 60 * 60 * 1000); // 24小时 * 60分钟 * 60秒 * 1000毫秒
    }

    // 检查并删除超过90天的消息
    function deleteOldMessages() {
      if (!state.isConnected) return;
      
      const ninetyDaysAgo = new Date();
      ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
      
      console.log(`Checking for messages older than ${ninetyDaysAgo.toISOString()}`);
      
      // 遍历所有消息
      state.messages.forEach(msg => {
        const messageDate = new Date(msg.timestamp);
        if (messageDate < ninetyDaysAgo) {
          // 删除超过90天的消息
          messagesRef.child(msg.id).remove()
            .then(() => {
              console.log(`Deleted old message ${msg.id} from ${msg.timestamp}`);
              
              // 只在李浩瑾在线时显示系统通知
              if (state.currentUser && state.currentUser.username === '李浩瑾') {
                showNotification(`已自动删除一条超过90天的旧消息`, 'info');
              }
            })
            .catch(error => {
              console.error('Error deleting old message:', error);
            });
        }
      });
    }

    // 授予管理员权限
    function grantAdminRights(username) {
      if (!state.isConnected || !state.currentUser || !state.currentUser.isAdmin) return;
      
      // 查找用户
      usersRef.orderByChild('username').equalTo(username).once('value')
        .then((snapshot) => {
          if (snapshot.exists()) {
            const userKey = Object.keys(snapshot.val())[0];
            // 更新用户为管理员
            usersRef.child(userKey).update({
              isAdmin: true
            })
            .then(() => {
              // 发送系统消息通知
              const systemMessage = {
                sender: '系统',
                content: `${username} 已被授予管理员权限`,
                timestamp: new Date().toISOString(),
                type: 'public',
                retracted: false
              };
              
              // 保存到Firebase
              const messageRef = messagesRef.push(systemMessage);
              systemMessage.id = messageRef.key;
              messageRef.update({ id: systemMessage.id });
              
              showNotification(`已授予 ${username} 管理员权限`, 'info');
              // 刷新用户列表
              renderUserLists();
            });
          }
        });
    }

    // 撤销管理员权限（只有李浩瑾可以执行）
    function revokeAdminRights(username) {
      // 不能撤销李浩瑾自己的管理员权限
      if (!state.isConnected || !state.currentUser || state.currentUser.username !== '李浩瑾' || username === '李浩瑾') return;
      
      // 查找用户
      usersRef.orderByChild('username').equalTo(username).once('value')
        .then((snapshot) => {
          if (snapshot.exists()) {
            const userKey = Object.keys(snapshot.val())[0];
            // 更新用户为非管理员
            usersRef.child(userKey).update({
              isAdmin: false
            })
            .then(() => {
              // 发送系统消息通知
              const systemMessage = {
                sender: '系统',
                content: `${username} 的管理员权限已被撤销`,
                timestamp: new Date().toISOString(),
                type: 'public',
                retracted: false
              };
              
              // 保存到Firebase
              const messageRef = messagesRef.push(systemMessage);
              systemMessage.id = messageRef.key;
              messageRef.update({ id: systemMessage.id });
              
              showNotification(`已撤销 ${username} 的管理员权限`, 'info');
              // 刷新用户列表
              renderUserLists();
            });
          }
        });
    }

    // 显示管理员权限操作确认对话框
    function showAdminActionConfirmation(username, actionType) {
      state.adminActionUser = username;
      state.adminActionType = actionType;
      
      elements.adminUsername.textContent = username;
      
      if (actionType === 'grant') {
        elements.adminModalTitle.textContent = '授予管理员权限';
        elements.adminModalMessage.textContent = `您确定要授予 ${username} 管理员权限吗？他们将获得踢人、删除消息等管理权限。`;
        elements.confirmAdminAction.textContent = '授予权限';
      } else {
        elements.adminModalTitle.textContent = '撤销管理员权限';
        elements.adminModalMessage.textContent = `您确定要撤销 ${username} 的管理员权限吗？他们将失去踢人、删除消息等管理权限。`;
        elements.confirmAdminAction.textContent = '撤销权限';
      }
      
      elements.adminPermissionModal.classList.remove('hidden');
    }

    // 从本地存储加载已删除的消息
    function loadDeletedMessages() {
      const savedDeletedMessages = localStorage.getItem('deletedChatMessages');
      if (savedDeletedMessages) {
        try {
          state.deletedMessages = JSON.parse(savedDeletedMessages);
        } catch (e) {
          console.error('Failed to load deleted messages:', e);
          state.deletedMessages = [];
        }
      }
    }

    // 从本地存储加载已屏蔽的用户
    function loadBlockedUsers() {
      const savedBlockedUsers = localStorage.getItem('blockedChatUsers');
      if (savedBlockedUsers) {
        try {
          state.blockedUsers = JSON.parse(savedBlockedUsers);
        } catch (e) {
          console.error('Failed to load blocked users:', e);
          state.blockedUsers = [];
        }
      }
    }

    // 保存已删除的消息到本地存储
    function saveDeletedMessages() {
      localStorage.setItem('deletedChatMessages', JSON.stringify(state.deletedMessages));
    }

    // 保存已屏蔽的用户到本地存储
    function saveBlockedUsers() {
      localStorage.setItem('blockedChatUsers', JSON.stringify(state.blockedUsers));
    }

    // 保存登录信息
    function saveLoginInfo(username, password) {
      if (state.rememberMe) {
        localStorage.setItem('savedChatLogin', JSON.stringify({ username, password }));
      } else {
        localStorage.removeItem('savedChatLogin');
      }
    }

    // 清除保存的登录信息
    function clearSavedLoginInfo() {
      localStorage.removeItem('savedChatLogin');
    }

    // 添加消息到已删除列表
    function addToDeletedMessages(messageId) {
      if (!state.deletedMessages.includes(messageId)) {
        state.deletedMessages.push(messageId);
        saveDeletedMessages();
      }
    }

    // 从已删除列表移除消息
    function removeFromDeletedMessages(messageId) {
      const index = state.deletedMessages.indexOf(messageId);
      if (index !== -1) {
        state.deletedMessages.splice(index, 1);
        saveDeletedMessages();
      }
    }

    // 清空已删除消息列表
    function clearDeletedMessages() {
      state.deletedMessages = [];
      saveDeletedMessages();
    }

    // 添加用户到已屏蔽列表
    function addToBlockedUsers(username) {
      if (!state.blockedUsers.includes(username)) {
        state.blockedUsers.push(username);
        saveBlockedUsers();
        renderUserLists();
        renderMessages();
      }
    }

    // 从已屏蔽列表移除用户
    function removeFromBlockedUsers(username) {
      const index = state.blockedUsers.indexOf(username);
      if (index !== -1) {
        state.blockedUsers.splice(index, 1);
        saveBlockedUsers();
        renderUserLists();
        renderMessages();
      }
    }

    // 优化点5: 优化Firebase监听器设置，减少初始数据传输
    function setupFirebaseListeners(usersRef, messagesRef, presenceRef, userStatusRef, reportsRef, mutedUsersRef, reportCountsRef) {
      // 监听连接状态
      presenceRef.on('value', (snapshot) => {
        state.isConnected = snapshot.val();
        
        // 清除连接超时计时器
        if (state.isConnected && state.connectionTimeout) {
          clearTimeout(state.connectionTimeout);
          state.connectionTimeout = null;
        }
        
        if (state.isConnected) {
          elements.connectionStatus.classList.add('hidden');
          hideLoadingScreen();
          
          // 如果没有显示其他屏幕，显示密码屏幕
          if (elements.loadingScreen.classList.contains('hidden') &&
              elements.passwordScreen.classList.contains('hidden') &&
              elements.authScreen.classList.contains('hidden') &&
              elements.chatScreen.classList.contains('hidden')) {
            elements.passwordScreen.classList.remove('hidden');
          }
          
          if (state.currentUser && !state.isGuest) {
            // 当连接恢复时更新用户状态
            updateUserStatus(usersRef, userStatusRef, state.currentUser.username, true);
            
            // 创建断开连接时的处理程序
            const userStatus = userStatusRef.child(state.currentUser.username);
            userStatus.onDisconnect().set({
              online: false,
              lastActive: new Date().toISOString()
            });
          }
        } else {
          elements.connectionStatus.classList.remove('hidden');
          showNotification('连接已断开，正在尝试重连...', 'error');
        }
      });
      
      // 监听用户数据变化 - 只加载必要的用户信息
      usersRef.on('value', (snapshot) => {
        const usersData = snapshot.val();
        if (usersData) {
          state.users = Object.values(usersData);
          renderUserLists();
          // 如果有活跃的用户搜索，重新应用搜索
          if (state.search.userQuery) {
            filterUsers();
          }
        }
      });
      
      // 优化点6: 限制初始消息加载数量，只加载最近的消息
      const recentMessagesQuery = messagesRef.orderByChild('timestamp').limitToLast(100);
      recentMessagesQuery.on('value', (snapshot) => {
        const messagesData = snapshot.val();
        if (messagesData) {
          // 转换为数组并排序
          state.messages = Object.values(messagesData).sort((a, b) => 
            new Date(a.timestamp) - new Date(b.timestamp)
          );
          
          // 如果有活跃的消息搜索，重新应用搜索
          if (state.search.messageQuery) {
            searchMessages(state.search.messageQuery);
          } else if (!elements.chatScreen.classList.contains('hidden')) {
            // 只在聊天界面显示时重新渲染消息
            renderMessages();
            scrollToBottom();
          }
        }
      });
      
      // 新增：监听举报信息
      reportsRef.on('value', (snapshot) => {
        const reportsData = snapshot.val();
        if (reportsData) {
          state.reports = Object.values(reportsData);
          
          // 只对李浩瑾显示举报管理按钮和计数
          if (state.currentUser && state.currentUser.username === '李浩瑾') {
            const pendingReports = state.reports.filter(r => r.status === 'pending');
            elements.reportsBtn.classList.remove('hidden');
            
            if (pendingReports.length > 0) {
              elements.reportsCount.textContent = pendingReports.length;
              elements.reportsCount.classList.remove('hidden');
            } else {
              elements.reportsCount.classList.add('hidden');
            }
            
            // 如果举报面板打开，刷新内容
            if (!elements.reportsPanel.classList.contains('hidden')) {
              renderReportsList();
            }
          }
        }
      });
      
      // 新增：监听禁言用户
      mutedUsersRef.on('value', (snapshot) => {
        const mutedData = snapshot.val();
        if (mutedData) {
          state.mutedUsers = mutedData;
          checkMuteStatus();
          renderUserLists();
        }
      });
      
      // 新增：监听举报计数
      reportCountsRef.on('value', (snapshot) => {
        const countsData = snapshot.val();
        if (countsData) {
          state.reportCounts = countsData;
        }
      });
    }

    // 等待连接建立
    function waitForConnection() {
      return new Promise((resolve) => {
        if (state.isConnected) {
          resolve();
          return;
        }
        
        const checkConnection = setInterval(() => {
          if (state.isConnected) {
            clearInterval(checkConnection);
            resolve();
          }
        }, 100);
      });
    }

    // 隐藏加载屏幕
    function hideLoadingScreen() {
      elements.loadingScreen.classList.add('opacity-0', 'pointer-events-none');
      elements.loadingScreen.style.transition = 'opacity 0.5s ease';
      setTimeout(() => {
        elements.loadingScreen.classList.add('hidden');
      }, 500);
    }

    // 绑定事件处理程序
    function bindEvents() {
      // 浏览模式按钮点击事件
      elements.browseModeBtn.addEventListener('click', enterBrowseMode);
      
      // 游客登录按钮点击事件
      elements.guestLoginBtn.addEventListener('click', () => {
        elements.chatScreen.classList.add('hidden');
        elements.authScreen.classList.remove('hidden');
        state.isGuest = false;
      });
      
      // 密码表单事件
      elements.passwordForm.addEventListener('submit', handlePasswordSubmit);
      elements.toggleAccessPassword.addEventListener('click', () => togglePasswordVisibility(elements.accessPassword, elements.toggleAccessPassword));
      
      // 认证表单切换
      elements.loginTab.addEventListener('click', () => switchAuthTab('login'));
      elements.registerTab.addEventListener('click', () => switchAuthTab('register'));
      
      // 登录表单事件
      elements.loginForm.addEventListener('submit', handleLoginSubmit);
      elements.toggleLoginPassword.addEventListener('click', () => togglePasswordVisibility(elements.loginPassword, elements.toggleLoginPassword));
      
      // 记住我选项变化事件
      elements.rememberMe.addEventListener('change', (e) => {
        state.rememberMe = e.target.checked;
      });
      
      // 注册表单事件
      elements.registerForm.addEventListener('submit', handleRegisterSubmit);
      elements.toggleRegisterPassword.addEventListener('click', () => togglePasswordVisibility(elements.registerPassword, elements.toggleRegisterPassword));
      elements.toggleConfirmPassword.addEventListener('click', () => togglePasswordVisibility(elements.registerConfirm, elements.toggleConfirmPassword));
      
      // 聊天界面事件
      elements.logoutBtn.addEventListener('click', handleLogout);
      elements.messageForm.addEventListener('submit', handleMessageSubmit);
      elements.messageInput.addEventListener('input', adjustTextareaHeight);
      elements.userSearch.addEventListener('input', handleUserSearch);
      elements.backToPublic.addEventListener('click', switchToPublicChat);
      
      // 消息搜索事件
      elements.messageSearch.addEventListener('input', handleMessageSearch);
      elements.clearMessageSearch.addEventListener('click', clearMessageSearch);
      elements.searchPrev.addEventListener('click', goToPrevResult);
      elements.searchNext.addEventListener('click', goToNextResult);
      
      // 清空聊天记录事件
      elements.clearChatBtn.addEventListener('click', () => {
        elements.clearChatModal.classList.remove('hidden');
      });
      
      elements.cancelClearChat.addEventListener('click', () => {
        elements.clearChatModal.classList.add('hidden');
      });
      
      elements.confirmClearChat.addEventListener('click', () => {
        clearAllMessages();
        elements.clearChatModal.classList.add('hidden');
      });
      
      // 删除消息事件
      elements.cancelDeleteMessage.addEventListener('click', () => {
        elements.deleteMessageModal.classList.add('hidden');
        state.messageToDelete = null;
      });
      
      elements.confirmDeleteMessage.addEventListener('click', () => {
        if (state.messageToDelete) {
          deleteMessageForAll(state.messageToDelete);
        }
        elements.deleteMessageModal.classList.add('hidden');
        state.messageToDelete = null;
      });
      
      // 踢人功能事件
      elements.cancelKick.addEventListener('click', () => {
        elements.kickModal.classList.add('hidden');
        state.kickedUser = null;
      });
      
      elements.confirmKick.addEventListener('click', () => {
        if (state.kickedUser) {
          performKick(state.kickedUser);
        }
        elements.kickModal.classList.add('hidden');
        state.kickedUser = null;
      });
      
      // 举报功能事件
      elements.cancelReport.addEventListener('click', () => {
        elements.reportModal.classList.add('hidden');
        state.reportedMessage = null;
      });
      
      elements.confirmReport.addEventListener('click', () => {
        if (state.reportedMessage) {
          submitReport(state.reportedMessage);
        }
        elements.reportModal.classList.add('hidden');
        state.reportedMessage = null;
      });
      
      // 举报管理面板事件
      elements.reportsBtn.addEventListener('click', () => {
        elements.reportsPanel.classList.remove('hidden');
        renderReportsList();
      });
      
      elements.closeReportsPanel.addEventListener('click', () => {
        elements.reportsPanel.classList.add('hidden');
      });
      
      // 屏蔽用户事件
      elements.cancelBlock.addEventListener('click', () => {
        elements.blockUserModal.classList.add('hidden');
        state.blockedUser = null;
      });
      
      elements.confirmBlock.addEventListener('click', () => {
        if (state.blockedUser) {
          addToBlockedUsers(state.blockedUser);
          showNotification(`已屏蔽 ${state.blockedUser}`, 'info');
        }
        elements.blockUserModal.classList.add('hidden');
        state.blockedUser = null;
      });
      
      // 取消屏蔽用户事件
      elements.cancelUnblock.addEventListener('click', () => {
        elements.unblockUserModal.classList.add('hidden');
        state.blockedUser = null;
      });
      
      elements.confirmUnblock.addEventListener('click', () => {
        if (state.blockedUser) {
          removeFromBlockedUsers(state.blockedUser);
          showNotification(`已取消屏蔽 ${state.blockedUser}`, 'info');
        }
        elements.unblockUserModal.classList.add('hidden');
        state.blockedUser = null;
      });
      
      // 管理员权限事件
      elements.cancelAdminAction.addEventListener('click', () => {
        elements.adminPermissionModal.classList.add('hidden');
        state.adminActionUser = null;
        state.adminActionType = null;
      });
      
      elements.confirmAdminAction.addEventListener('click', () => {
        if (state.adminActionUser && state.adminActionType) {
          if (state.adminActionType === 'grant') {
            grantAdminRights(state.adminActionUser);
          } else {
            revokeAdminRights(state.adminActionUser);
          }
        }
        elements.adminPermissionModal.classList.add('hidden');
        state.adminActionUser = null;
        state.adminActionType = null;
      });
      
      // 键盘导航支持
      document.addEventListener('keydown', (e) => {
        // 当消息搜索框聚焦且有搜索结果时，支持上下箭头导航
        if (document.activeElement === elements.messageSearch && state.search.messageResults.length > 0) {
          if (e.key === 'ArrowUp') {
            e.preventDefault();
            goToPrevResult();
          } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            goToNextResult();
          }
        }
      });
      
      // 窗口焦点事件 - 用于更新在线状态
      window.addEventListener('focus', () => {
        if (state.currentUser && state.isConnected && !state.isGuest) {
          updateUserStatus(usersRef, userStatusRef, state.currentUser.username, true);
        }
      });
      
      window.addEventListener('blur', () => {
        if (state.currentUser && state.isConnected && !state.isGuest) {
          updateUserStatus(usersRef, userStatusRef, state.currentUser.username, false);
        }
      });
    }

    // 进入浏览模式
    function enterBrowseMode() {
      state.isGuest = true;
      state.currentUser = null;
      
      // 进入聊天界面
      elements.passwordScreen.classList.add('hidden');
      elements.authScreen.classList.add('hidden');
      elements.chatScreen.classList.remove('hidden');
      
      // 显示游客提示
      elements.guestModeIndicator.classList.remove('hidden');
      elements.guestInputHint.classList.remove('hidden');
      elements.guestLoginBtn.classList.remove('hidden');
      
      // 隐藏用户相关信息
      elements.currentUser.classList.add('hidden');
      elements.logoutBtn.classList.add('hidden');
      
      // 禁用消息输入和发送功能
      elements.messageInput.disabled = true;
      elements.messageInput.placeholder = "请登录后发送消息...";
      
      // 初始化聊天界面
      initChatInterface();
      
      showNotification('已进入浏览模式，登录后可发送消息', 'info');
    }

    // 处理用户搜索
    function handleUserSearch(e) {
      const query = e.target.value.toLowerCase().trim();
      state.search.userQuery = query;
      filterUsers();
    }

    // 处理消息搜索
    function handleMessageSearch(e) {
      const query = e.target.value.toLowerCase().trim();
      state.search.messageQuery = query;
      
      if (query) {
        elements.clearMessageSearch.classList.remove('hidden');
        searchMessages(query);
      } else {
        clearMessageSearch();
      }
    }

    // 清除消息搜索
    function clearMessageSearch() {
      elements.messageSearch.value = '';
      state.search.messageQuery = '';
      state.search.messageResults = [];
      state.search.currentResultIndex = -1;
      
      elements.clearMessageSearch.classList.add('hidden');
      elements.messageSearchResults.classList.add('hidden');
      elements.searchNavigation.classList.add('hidden');
      
      // 重新渲染所有消息
      renderMessages();
    }

    // 搜索消息
    function searchMessages(query) {
      // 根据当前聊天类型过滤消息
      let filteredMessages = [];
      
      if (state.currentChat.type === 'public') {
        // 公共聊天显示所有公共消息，排除已删除的和被屏蔽用户的消息
        filteredMessages = state.messages.filter(msg => 
          msg.type === 'public' && 
          !state.deletedMessages.includes(msg.id) &&
          !state.blockedUsers.includes(msg.sender)
        );
      } else {
        // 私聊显示双方之间的消息，排除已删除的
        filteredMessages = state.messages.filter(msg => 
          msg.type === 'private' && 
          !state.deletedMessages.includes(msg.id) &&
          ((msg.sender === state.currentUser?.username && msg.recipient === state.currentChat.target) || 
           (msg.sender === state.currentChat.target && msg.recipient === state.currentUser?.username) ||
           (msg.sender === '系统' && msg.recipient === state.currentUser?.username))
        );
      }
      
      // 搜索包含关键词的消息
      const results = filteredMessages.filter(msg => 
        !msg.retracted && 
        (msg.content.toLowerCase().includes(query) || 
         msg.sender.toLowerCase().includes(query))
      );
      
      state.search.messageResults = results;
      state.search.currentResultIndex = results.length > 0 ? 0 : -1;
      
      // 更新搜索结果计数
      elements.messageSearchResults.textContent = `${results.length} 条匹配消息`;
      elements.messageSearchResults.classList.remove('hidden');
      
      // 更新导航控件
      updateSearchNavigation();
      
      // 渲染搜索结果
      renderMessageSearchResults();
      
      // 如果有结果，滚动到第一个匹配项
      if (results.length > 0) {
        scrollToCurrentResult();
      }
    }

    // 更新搜索导航控件
    function updateSearchNavigation() {
      const hasResults = state.search.messageResults.length > 0;
      
      if (hasResults) {
        elements.searchNavigation.classList.remove('hidden');
        elements.searchCurrent.textContent = state.search.currentResultIndex + 1;
        elements.searchTotal.textContent = state.search.messageResults.length;
        
        // 禁用/启用导航按钮
        elements.searchPrev.disabled = state.search.currentResultIndex === 0;
        elements.searchNext.disabled = state.search.currentResultIndex === state.search.messageResults.length - 1;
      } else {
        elements.searchNavigation.classList.add('hidden');
      }
    }

    // 导航到上一个搜索结果
    function goToPrevResult() {
      if (state.search.currentResultIndex > 0) {
        state.search.currentResultIndex--;
        updateSearchNavigation();
        renderMessageSearchResults();
        scrollToCurrentResult();
      }
    }

    // 导航到下一个搜索结果
    function goToNextResult() {
      if (state.search.currentResultIndex < state.search.messageResults.length - 1) {
        state.search.currentResultIndex++;
        updateSearchNavigation();
        renderMessageSearchResults();
        scrollToCurrentResult();
      }
    }

    // 滚动到当前选中的搜索结果
    function scrollToCurrentResult() {
      if (state.search.currentResultIndex >= 0 && state.search.messageResults.length > 0) {
        const messageId = state.search.messageResults[state.search.currentResultIndex].id;
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        
        if (messageElement) {
          // 高亮当前结果
          messageElement.classList.add('bg-primary/5');
          messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // 移除高亮
          setTimeout(() => {
            messageElement.classList.remove('bg-primary/5');
          }, 2000);
        }
      }
    }

    // 渲染消息搜索结果
    function renderMessageSearchResults() {
      elements.messagesContainer.innerHTML = `
        <div class="text-center text-gray-500 text-sm">
          今天是 <span id="current-date">${elements.currentDate.textContent}</span>
        </div>
        <div class="text-center text-sm text-gray-500 mb-2">
          搜索结果: "${state.search.messageQuery}" (${state.search.messageResults.length} 条)
        </div>
      `;
      
      // 添加消息到容器
      state.search.messageResults.forEach((msg, index) => {
        const messageElement = createMessageElement(msg, true);
        messageElement.dataset.messageId = msg.id;
        messageElement.dataset.messageId = msg.id;
        
        // 标记当前选中的结果
        if (index === state.search.currentResultIndex) {
          messageElement.classList.add('ring-2', 'ring-primary', 'ring-opacity-50');
        }
        
        elements.messagesContainer.appendChild(messageElement);
      });
    }

    // 验证用户并进入聊天室
    function verifyUserAndEnterChat(username, password) {
      usersRef.orderByChild('username').equalTo(username).once('value')
        .then((snapshot) => {
          const userData = snapshot.val();
          if (userData) {
            const user = Object.values(userData)[0];
            if (user.password === password) {
              // 验证成功
              state.currentUser = user;
              state.isGuest = false;
              localStorage.setItem('currentChatUser', JSON.stringify(user));
              
              // 保存登录信息（如果勾选了记住我）
              saveLoginInfo(username, password);
              
              // 更新用户状态为在线
              updateUserStatus(usersRef, userStatusRef, username, true);
              
              // 进入聊天界面
              elements.authScreen.classList.add('hidden');
              elements.passwordScreen.classList.add('hidden');
              elements.chatScreen.classList.remove('hidden');
              
              // 隐藏游客相关元素
              elements.guestModeIndicator.classList.add('hidden');
              elements.guestInputHint.classList.add('hidden');
              elements.guestLoginBtn.classList.add('hidden');
              
              // 显示用户相关元素
              elements.currentUser.classList.remove('hidden');
              elements.logoutBtn.classList.remove('hidden');
              
              // 启用消息输入
              elements.messageInput.disabled = false;
              elements.messageInput.placeholder = "输入消息...";
              
              // 初始化聊天界面
              initChatInterface();
              
              // 检查禁言状态
              checkMuteStatus();
              
              showNotification('登录成功', 'success');
            } else {
              // 密码错误
              handleLoginFailure('用户名或密码错误');
            }
          } else {
            // 用户不存在
            handleLoginFailure('用户名或密码错误');
          }
        })
        .catch((error) => {
          console.error('验证用户失败:', error);
          showNotification('登录失败，请重试', 'error');
        });
    }

    // 处理登录失败
    function handleLoginFailure(message) {
      state.currentUser = null;
      localStorage.removeItem('currentChatUser');
      showAuthMessage(message, 'error');
      elements.passwordScreen.classList.remove('hidden');
      elements.authScreen.classList.add('hidden');
    }

    // 处理密码提交
    function handlePasswordSubmit(e) {
      e.preventDefault();
      
      const password = elements.accessPassword.value.trim();
      
      if (password === state.accessPassword) {
        // 密码正确，进入认证页面
        elements.passwordScreen.classList.add('hidden');
        elements.authScreen.classList.remove('hidden');
        
        // 清空密码输入
        elements.accessPassword.value = '';
        elements.passwordError.classList.add('hidden');
      } else {
        // 密码错误
        elements.passwordError.classList.remove('hidden');
        elements.accessPassword.classList.add('border-red-500');
        
        // 添加抖动动画
        elements.accessPassword.classList.add('shake');
        setTimeout(() => {
          elements.accessPassword.classList.remove('shake');
        }, 500);
      }
    }

    // 切换认证标签
    function switchAuthTab(tab) {
      if (tab === 'login') {
        elements.loginTab.classList.add('text-primary', 'border-primary');
        elements.loginTab.classList.remove('text-gray-500', 'border-transparent');
        elements.registerTab.classList.add('text-gray-500', 'border-transparent');
        elements.registerTab.classList.remove('text-primary', 'border-primary');
        elements.loginForm.classList.remove('hidden');
        elements.registerForm.classList.add('hidden');
      } else {
        elements.registerTab.classList.add('text-primary', 'border-primary');
        elements.registerTab.classList.remove('text-gray-500', 'border-transparent');
        elements.loginTab.classList.add('text-gray-500', 'border-transparent');
        elements.loginTab.classList.remove('text-primary', 'border-primary');
        elements.registerForm.classList.remove('hidden');
        elements.loginForm.classList.add('hidden');
      }
      
      // 重置消息
      elements.authMessage.classList.add('hidden');
    }

    // 处理登录提交
    function handleLoginSubmit(e) {
      e.preventDefault();
      
      const username = elements.loginUsername.value.trim();
      const password = elements.loginPassword.value.trim();
      
      // 保存记住我状态
      state.rememberMe = elements.rememberMe.checked;
      
      waitForConnection().then(() => {
        verifyUserAndEnterChat(username, password);
      });
    }

    // 处理注册提交
    function handleRegisterSubmit(e) {
      e.preventDefault();
      
      const username = elements.registerUsername.value.trim();
      const password = elements.registerPassword.value.trim();
      const confirm = elements.registerConfirm.value.trim();
      
      // 验证
      if (username.length < 3) {
        showAuthMessage('用户名至少需要3个字符', 'error');
        return;
      }
      
      if (password.length < 6) {
        showAuthMessage('密码至少需要6个字符', 'error');
        return;
      }
      
      if (password !== confirm) {
        showAuthMessage('两次输入的密码不一致', 'error');
        return;
      }
      
      waitForConnection().then(() => {
        // 检查用户名是否已存在
        usersRef.orderByChild('username').equalTo(username).once('value')
          .then((snapshot) => {
            if (snapshot.exists()) {
              showAuthMessage('用户名已存在', 'error');
              return;
            }
            
            // 创建新用户，李浩瑾默认是管理员
            const newUser = {
              username,
              password,
              online: true,
              lastActive: new Date().toISOString(),
              lastActive: new Date().toISOString(),
              isAdmin: username === '李浩瑾' // 李浩瑾默认是管理员
            };
            
            // 保存到Firebase
            const userRef = usersRef.push();
            newUser.id = userRef.key;
            userRef.set(newUser)
              .then(() => {
                state.currentUser = newUser;
                state.isGuest = false;
                localStorage.setItem('currentChatUser', JSON.stringify(newUser));
                
                // 保存登录信息（默认不记住，除非用户明确勾选）
                if (elements.rememberMe.checked) {
                  state.rememberMe = true;
                  saveLoginInfo(username, password);
                }
                
                // 设置断开连接时的处理
                const userStatus = userStatusRef.child(username);
                userStatus.onDisconnect().set({
                  online: false,
                  lastActive: new Date().toISOString()
                });
                
                // 进入聊天界面
                elements.authScreen.classList.add('hidden');
                elements.chatScreen.classList.remove('hidden');
                
                // 隐藏游客相关元素
                elements.guestModeIndicator.classList.add('hidden');
                elements.guestInputHint.classList.add('hidden');
                elements.guestLoginBtn.classList.add('hidden');
                
                // 显示用户相关元素
                elements.currentUser.classList.remove('hidden');
                elements.logoutBtn.classList.remove('hidden');
                
                // 启用消息输入
                elements.messageInput.disabled = false;
                elements.messageInput.placeholder = "输入消息...";
                
                // 初始化聊天界面
                initChatInterface();
                
                showNotification('注册成功', 'success');
                
                // 清空表单
                elements.registerForm.reset();
              })
              .catch((error) => {
                console.error('注册失败:', error);
                showAuthMessage('注册失败，请重试', 'error');
              });
          });
      });
    }

    // 初始化聊天界面
    function initChatInterface() {
      // 显示当前用户
      if (state.currentUser) {
        elements.currentUser.textContent = state.currentUser.username;
      }
      
      // 渲染用户列表
      renderUserLists();
      
      // 渲染消息
      renderMessages();
      
      // 自动调整文本框高度
      adjustTextareaHeight();
      
      // 滚动到底部
      scrollToBottom();
    }

    // 渲染用户列表（在线、离线和已屏蔽）
    function renderUserLists() {
      elements.onlineUserList.innerHTML = '';
      elements.offlineUserList.innerHTML = '';
      elements.blockedUserList.innerHTML = '';
      
      // 分离在线和离线用户
      const onlineUsers = state.users.filter(user => user.online && user.username !== state.currentUser?.username).sort((a, b) => {
        return a.username.localeCompare(b.username);
      });
      
      const offlineUsers = state.users.filter(user => !user.online && user.username !== state.currentUser?.username).sort((a, b) => {
        return a.username.localeCompare(b.username);
      });
      
      // 更新在线人数（包括当前用户）
      elements.onlineCount.textContent = onlineUsers.length + (state.currentUser && !state.isGuest ? 1 : 0);
      
      // 如果不是游客，添加当前用户到在线列表顶部
      if (state.currentUser && !state.isGuest) {
        const currentUserElement = createUserElement({
          username: state.currentUser.username,
          online: true,
          isAdmin: state.currentUser.isAdmin
        }, true, true);
        elements.onlineUserList.appendChild(currentUserElement);
      }
      
      // 添加在线用户到列表
      onlineUsers.forEach(user => {
        const userElement = createUserElement(user, true);
        elements.onlineUserList.appendChild(userElement);
      });
      
      // 添加离线用户到列表
      offlineUsers.forEach(user => {
        const userElement = createUserElement(user, false);
        elements.offlineUserList.appendChild(userElement);
      });
      
      // 添加已屏蔽用户到列表
      if (state.blockedUsers.length > 0) {
        state.blockedUsers.forEach(username => {
          const user = state.users.find(u => u.username === username) || { username };
          const userElement = createBlockedUserElement(user);
          elements.blockedUserList.appendChild(userElement);
        });
      } else {
        // 如果没有屏蔽的用户，显示提示信息
        const emptyBlockedElement = document.createElement('div');
        emptyBlockedElement.className = 'p-3 text-center text-gray-500 text-sm';
        emptyBlockedElement.textContent = '暂无屏蔽用户';
        elements.blockedUserList.appendChild(emptyBlockedElement);
      }
    }

    // 创建用户元素
    function createUserElement(user, isOnline, isCurrentUser = false) {
      const userElement = document.createElement('div');
      const isAdmin = state.currentUser && state.currentUser.isAdmin;
      const canKick = isAdmin && !isCurrentUser && isOnline && !state.isGuest;
      const isBlocked = state.blockedUsers.includes(user.username);
      
      // 检查用户是否被禁言
      const isMuted = state.mutedUsers[user.username] && new Date(state.mutedUsers[user.username]) > new Date();
      
      // 游客模式下禁用交互功能
      const isInteractive = !state.isGuest;
      
      // 检查是否匹配搜索查询
      let username = user.username;
      const query = state.search.userQuery;
      let displayName = username;
      
      if (query && username.toLowerCase().includes(query)) {
        const index = username.toLowerCase().indexOf(query);
        displayName = `${username.substring(0, index)}<span class="search-highlight">${username.substring(index, index + query.length)}</span>${username.substring(index + query.length)}`;
      }
      
      userElement.className = `p-3 hover:bg-gray-50 transition-colors ${isInteractive ? 'cursor-pointer' : ''} flex items-center justify-between ${
        state.currentChat.type === 'private' && state.currentChat.target === user.username ? 'bg-primary/10' : ''
      } ${query && !username.toLowerCase().includes(query) ? 'hidden' : ''} ${isBlocked ? 'user-muted' : ''}`;
      
      userElement.innerHTML = `
        <div class="flex items-center">
          <div class="relative mr-3">
            <div class="w-8 h-8 rounded-full ${isOnline ? 'bg-primary/20' : 'bg-gray-200'} flex items-center justify-center ${isOnline ? 'text-primary' : 'text-gray-500'} font-medium">
              ${username.charAt(0).toUpperCase()}
            </div>
            <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-400'} border-2 border-white"></span>
            ${isBlocked ? '<span class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white flex items-center justify-center text-white text-[10px]">-</span>' : ''}
            ${isMuted ? '<span class="absolute top-0 right-0 w-3 h-3 bg-warning rounded-full border-2 border-white flex items-center justify-center text-white text-[10px]">!</span>' : ''}
          </div>
          <span class="font-medium ${isCurrentUser ? 'text-primary' : (isOnline ? '' : 'text-gray-500')}">
            ${isCurrentUser ? `${displayName} (你)` : displayName}
            ${user.isAdmin ? '<span class="ml-1 text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded">管理员</span>' : ''}
            ${isBlocked ? '<span class="ml-1 text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">已屏蔽</span>' : ''}
            ${isMuted ? '<span class="ml-1 text-xs bg-warning/10 text-warning px-1.5 py-0.5 rounded">已禁言</span>' : ''}
          </span>
        </div>
        ${state.currentChat.type === 'private' && state.currentChat.target === username ? 
          '<i class="fa fa-check-circle text-primary"></i>' : ''}
        <div class="flex space-x-1">
          ${!isCurrentUser && isInteractive ? `
            <button class="${isBlocked ? 'unblock-user' : 'block-user'} ${isBlocked ? 'text-green-400 hover:text-green-600' : 'text-red-400 hover:text-red-600'} opacity-0 hover:opacity-100 transition-opacity" 
                    data-username="${username}" title="${isBlocked ? '取消屏蔽' : '屏蔽用户'}">
              <i class="${isBlocked ? 'fa fa-check' : 'fa fa-ban'}"></i>
            </button>
          ` : ''}
          ${canKick ? `
            <button class="kick-user text-red-400 hover:text-red-600 opacity-0 hover:opacity-100 transition-opacity" 
                    data-username="${username}" title="踢出聊天室">
              <i class="fa fa-sign-out"></i>
            </button>
          ` : ''}
          ${state.currentUser && !isCurrentUser && !isBlocked && isInteractive ? `
            ${state.currentUser.isAdmin && !user.isAdmin ? `
              <button class="grant-admin text-blue-400 hover:text-blue-600 opacity-0 hover:opacity-100 transition-opacity" 
                      data-username="${username}" title="授予管理员权限">
                <i class="fa fa-star-o"></i>
              </button>
            ` : (state.currentUser.username === '李浩瑾' && user.isAdmin ? `
              <button class="revoke-admin text-yellow-400 hover:text-yellow-600 opacity-0 hover:opacity-100 transition-opacity" 
                      data-username="${username}" title="撤销管理员权限">
                <i class="fa fa-star"></i>
              </button>
            ` : '')}
          ` : ''}
        </div>
      `;
      
      // 点击用户进行私聊（除了自己和被屏蔽的用户，且不是游客）
      if (!isCurrentUser && !isBlocked && isInteractive) {
        userElement.addEventListener('click', (e) => {
          // 如果点击的是操作按钮，则不触发私聊
          if (!e.target.closest('.kick-user') && !e.target.closest('.block-user') && !e.target.closest('.unblock-user') &&
              !e.target.closest('.grant-admin') && !e.target.closest('.revoke-admin')) {
            startPrivateChat(username);
          }
        });
      }
      
      // 添加踢人事件
      if (canKick) {
        const kickBtn = userElement.querySelector('.kick-user');
        kickBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const username = e.currentTarget.getAttribute('data-username');
          showKickConfirmation(username);
        });
      }
      
      // 添加屏蔽/取消屏蔽事件
      if (!isCurrentUser && isInteractive) {
        const blockBtn = userElement.querySelector(isBlocked ? '.unblock-user' : '.block-user');
        if (blockBtn) {
          blockBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const username = e.currentTarget.getAttribute('data-username');
            if (isBlocked) {
              showUnblockConfirmation(username);
            } else {
              showBlockConfirmation(username);
            }
          });
        }
      }
      
      // 添加授予管理员权限事件
      const grantAdminBtn = userElement.querySelector('.grant-admin');
      if (grantAdminBtn) {
        grantAdminBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const username = e.currentTarget.getAttribute('data-username');
          showAdminActionConfirmation(username, 'grant');
        });
      }
      
      // 添加撤销管理员权限事件
      const revokeAdminBtn = userElement.querySelector('.revoke-admin');
      if (revokeAdminBtn) {
        revokeAdminBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const username = e.currentTarget.getAttribute('data-username');
          showAdminActionConfirmation(username, 'revoke');
        });
      }
      
      return userElement;
    }

    // 创建被屏蔽用户元素
    function createBlockedUserElement(user) {
      const userElement = document.createElement('div');
      const isInteractive = !state.isGuest;
      
      userElement.className = `p-3 hover:bg-gray-50 transition-colors ${isInteractive ? 'cursor-pointer' : ''} flex items-center justify-center user-muted`;
      
      userElement.innerHTML = `
        <div class="flex items-center">
          <div class="relative mr-3">
            <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-medium">
              ${user.username.charAt(0).toUpperCase()}
            </div>
            <span class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white flex items-center justify-center text-white text-[10px]">-</span>
          </div>
          <span class="font-medium text-gray-500">
            ${user.username}
            ${user.isAdmin ? '<span class="ml-1 text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded">管理员</span>' : ''}
            <span class="ml-1 text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">已屏蔽</span>
          </span>
        </div>
        ${isInteractive ? `
          <button class="unblock-user text-green-400 hover:text-green-600" 
                  data-username="${user.username}" title="取消屏蔽">
            <i class="fa fa-check"></i>
          </button>
        ` : ''}
      `;
      
      // 添加取消屏蔽事件
      if (isInteractive) {
        const unblockBtn = userElement.querySelector('.unblock-user');
        if (unblockBtn) {
          unblockBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const username = e.currentTarget.getAttribute('data-username');
            showUnblockConfirmation(username);
          });
        }
      }
      
      return userElement;
    }

    // 过滤用户列表
    function filterUsers() {
      const query = state.search.userQuery;
      const userElements = document.querySelectorAll('#online-user-list div, #offline-user-list div, #blocked-user-list div');
      
      let visibleCount = 0;
      
      userElements.forEach(element => {
        // 跳过空提示元素
        if (element.textContent.includes('暂无屏蔽用户')) return;
        
        const usernameElement = element.querySelector('span');
        // 提取原始用户名（不包含高亮标签）
        const usernameText = usernameElement.textContent.replace(' (你)', '').replace('管理员', '').replace('已屏蔽', '').replace('已禁言', '').trim().toLowerCase();
        
        if (query === '' || usernameText.includes(query)) {
          element.classList.remove('hidden');
          visibleCount++;
        } else {
          element.classList.add('hidden');
        }
      });
      
      // 更新搜索结果计数
      if (query) {
        elements.userSearchResults.textContent = `${visibleCount} 位匹配用户`;
        elements.userSearchResults.classList.remove('hidden');
      } else {
        elements.userSearchResults.classList.add('hidden');
      }
    }

    // 显示踢人确认对话框
    function showKickConfirmation(username) {
      state.kickedUser = username;
      elements.kickUsername.textContent = username;
      elements.kickModal.classList.remove('hidden');
    }

    // 执行踢人操作
    function performKick(username) {
      if (!state.isConnected) {
        showNotification('无法执行操作，当前未连接到服务器', 'error');
        return;
      }
      
      // 查找用户
      const userIndex = state.users.findIndex(u => u.username === username);
      if (userIndex !== -1) {
        // 更新用户状态为离线
        updateUserStatus(usersRef, userStatusRef, username, false);
        
        // 向被踢用户发送系统消息
        const systemMessage = {
          sender: '系统',
          content: `您已被管理员踢出聊天室`,
          timestamp: new Date().toISOString(),
          type: 'private',
          recipient: username,
          retracted: false
        };
        
        // 保存到Firebase
        messagesRef.push(systemMessage);
        
        // 向管理员发送确认消息
        showNotification(`已将 ${username} 踢出聊天室`, 'info');
      }
    }

    // 显示屏蔽用户确认对话框
    function showBlockConfirmation(username) {
      state.blockedUser = username;
      elements.blockUsername.textContent = username;
      elements.blockUserModal.classList.remove('hidden');
    }

    // 显示取消屏蔽用户确认对话框
    function showUnblockConfirmation(username) {
      state.blockedUser = username;
      elements.unblockUsername.textContent = username;
      elements.unblockUserModal.classList.remove('hidden');
    }

    // 显示举报确认对话框
    function showReportConfirmation(message) {
      state.reportedMessage = message;
      elements.reportSender.textContent = message.sender;
      elements.reportModal.classList.remove('hidden');
    }

    // 提交举报
    function submitReport(message) {
      if (!state.isConnected || state.isGuest) return;
      
      // 创建举报记录
      const report = {
        id: Date.now().toString(),
        messageId: message.id,
        messageContent: message.content,
        reporter: state.currentUser.username,
        reportedUser: message.sender,
        reason: elements.reportReason.value,
        timestamp: new Date().toISOString(),
        status: 'pending', // pending, approved, rejected
        handledBy: null,
        handledAt: null
      };
      
      // 保存到Firebase
      reportsRef.push(report);
      
      showNotification('举报已提交，等待管理员处理', 'info');
    }

    // 渲染举报列表
    function renderReportsList() {
      const pendingReports = state.reports.filter(r => r.status === 'pending');
      
      if (pendingReports.length === 0) {
        elements.noReports.classList.remove('hidden');
        elements.reportsList.innerHTML = '';
        return;
      }
      
      elements.noReports.classList.add('hidden');
      elements.reportsList.innerHTML = '';
      
      pendingReports.forEach(report => {
        const reportElement = document.createElement('div');
        reportElement.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
        
        // 检查消息是否包含敏感词
        const hasSensitiveWords = state.sensitiveWords.some(word => 
          report.messageContent.toLowerCase().includes(word.toLowerCase())
        );
        
        // 处理敏感词高亮显示
        let messageContent = report.messageContent;
        state.sensitiveWords.forEach(word => {
          if (messageContent.toLowerCase().includes(word.toLowerCase())) {
            const regex = new RegExp(`(${word})`, 'gi');
            messageContent = messageContent.replace(regex, '<span class="bg-red-100 text-red-800 px-1 rounded">$1</span>');
          }
        });
        
        reportElement.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div>
              <span class="font-medium">${report.reportedUser}</span>
              <span class="text-gray-500 text-sm ml-2">被举报</span>
            </div>
            <span class="text-xs text-gray-500">${formatDateTime(report.timestamp)}</span>
          </div>
          
          <div class="mb-3 p-2 bg-gray-50 rounded ${hasSensitiveWords ? 'border border-red-200' : ''}">
            ${messageContent}
            ${hasSensitiveWords ? '<div class="text-xs text-red-500 mt-1"><i class="fa fa-exclamation-circle mr-1"></i> 包含敏感词汇</div>' : ''}
          </div>
          
          <div class="mb-3 text-sm">
            <span class="text-gray-500">举报原因：</span>
            <span class="${getReasonClass(report.reason)}">${getReasonText(report.reason)}</span>
          </div>
          
          <div class="flex justify-end space-x-2">
